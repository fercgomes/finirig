name: Release Build

on:
  push:
    tags:
      - "v*"
      - "*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0-alpha.1)"
        required: true
        type: string

env:
  BUILD_TYPE: Release
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}
      patch: ${{ steps.version.outputs.patch }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
          else
            VERSION=$(cat VERSION 2>/dev/null || echo "0.0.0-dev")
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Parse version components
          IFS='-' read -r BASE PRERELEASE <<< "$VERSION"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"

          echo "major=${MAJOR:-0}" >> $GITHUB_OUTPUT
          echo "minor=${MINOR:-0}" >> $GITHUB_OUTPUT
          echo "patch=${PATCH:-0}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE:-}" >> $GITHUB_OUTPUT

          echo "Building version: $VERSION"

  build-macos:
    name: Build macOS
    runs-on: macos-14
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt6
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Generate Icons
        run: |
          chmod +x scripts/generate_icons.sh
          ./scripts/generate_icons.sh || true

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=$(brew --prefix qt@6) \
            -DBUILD_TESTS=OFF \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create macOS Package
        run: |
          cd build
          VERSION="${{ needs.version.outputs.version }}"

          # Create DMG
          mkdir -p dmg
          cp -R bin/Finirig.app dmg/

          # Create DMG using hdiutil
          hdiutil create -volname "Finirig $VERSION" \
            -srcfolder dmg \
            -ov -format UDZO \
            "Finirig-${VERSION}-macOS.dmg"

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-macos-${{ needs.version.outputs.version }}
          path: |
            build/bin/Finirig.app
            build/Finirig-*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt6
        uses: jurplel/install-qt-action@v4
        with:
          version: "6.7.0"
          modules: "qtbase qtwidgets"

      - name: Setup JUCE
        run: |
          if (-not (Test-Path "third_party\JUCE")) {
            git clone https://github.com/juce-framework/JUCE.git third_party\JUCE
          }

      - name: Generate Icons
        shell: bash
        run: |
          # Try to generate .ico if ImageMagick is available
          if command -v convert &> /dev/null; then
            convert resources/icon.png -define icon:auto-resize=256,128,64,48,32,16 resources/Finirig.ico
          fi

      - name: Configure CMake
        run: |
          cmake -B build `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_PREFIX_PATH="$env:Qt6_DIR" `
            -DBUILD_TESTS=OFF `
            -DBUILD_STANDALONE=ON `
            -G "Visual Studio 17 2022" `
            -A x64

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create Windows Package
        run: |
          cd build
          $VERSION = "${{ needs.version.outputs.version }}"

          # Create zip with executable
          $zipName = "Finirig-${VERSION}-Windows-x64.zip"
          Compress-Archive -Path "bin\finirig_standalone.exe" -DestinationPath $zipName -Force

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-windows-${{ needs.version.outputs.version }}
          path: |
            build/bin/finirig_standalone.exe
            build/Finirig-*.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            qt6-base-dev \
            libasound2-dev \
            libjack-jackd2-dev \
            libfreetype6-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxrender-dev

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create Linux Package
        run: |
          cd build
          VERSION="${{ needs.version.outputs.version }}"

          # Create tarball
          mkdir -p package/finirig-${VERSION}
          cp bin/finirig_standalone package/finirig-${VERSION}/
          cp ../resources/Finirig.png package/finirig-${VERSION}/
          cp ../resources/finirig.desktop package/finirig-${VERSION}/

          # Create install script
          cat > package/finirig-${VERSION}/install.sh << 'EOF'
          #!/bin/bash
          sudo cp finirig_standalone /usr/local/bin/
          sudo cp Finirig.png /usr/share/pixmaps/finirig.png
          sudo cp finirig.desktop /usr/share/applications/
          sudo update-desktop-database
          EOF
          chmod +x package/finirig-${VERSION}/install.sh

          tar -czf Finirig-${VERSION}-Linux-x64.tar.gz -C package finirig-${VERSION}

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-linux-${{ needs.version.outputs.version }}
          path: |
            build/bin/finirig_standalone
            build/Finirig-*.tar.gz
          retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build-macos, build-windows, build-linux]
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Finirig ${{ needs.version.outputs.version }}
          body: |
            ## Finirig ${{ needs.version.outputs.version }}

            ### Downloads

            - **macOS**: [Finirig.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-macOS.dmg)
            - **Windows**: [Finirig.zip](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-Windows-x64.zip)
            - **Linux**: [Finirig.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-Linux-x64.tar.gz)

            ### Installation

            **macOS**: Open the DMG and drag Finirig.app to Applications.

            **Windows**: Extract the ZIP and run `finirig_standalone.exe`.

            **Linux**: Extract the tarball and run `./install.sh` or manually copy files.

            ### Changes

            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: |
            artifacts/**/*
          draft: ${{ contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'rc') }}
          prerelease: ${{ contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: Release Build

on:
  push:
    tags:
      - "v*"
      - "*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., 1.0.0-alpha.1)"
        required: true
        type: string

env:
  BUILD_TYPE: Release
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}
      patch: ${{ steps.version.outputs.patch }}
      prerelease: ${{ steps.version.outputs.prerelease }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/}"
            # Remove 'v' prefix if present
            VERSION="${VERSION#v}"
          else
            VERSION=$(cat VERSION 2>/dev/null || echo "0.0.0-dev")
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Parse version components
          IFS='-' read -r BASE PRERELEASE <<< "$VERSION"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE"

          echo "major=${MAJOR:-0}" >> $GITHUB_OUTPUT
          echo "minor=${MINOR:-0}" >> $GITHUB_OUTPUT
          echo "patch=${PATCH:-0}" >> $GITHUB_OUTPUT
          echo "prerelease=${PRERELEASE:-}" >> $GITHUB_OUTPUT

          echo "Building version: $VERSION"

  build-macos:
    name: Build macOS
    runs-on: macos-14
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt6
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Generate Icons
        run: |
          chmod +x scripts/generate_icons.sh
          if [ -f resources/icon.png ]; then
            ./scripts/generate_icons.sh
          else
            echo "Warning: resources/icon.png not found, skipping icon generation"
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=$(brew --prefix qt@6) \
            -DBUILD_TESTS=OFF \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create macOS Package
        run: |
          cd build
          VERSION="${{ needs.version.outputs.version }}"

          # Find the app bundle (could be in bin/ or Release/ depending on generator)
          APP_BUNDLE=""
          if [ -d "bin/Finirig.app" ]; then
            APP_BUNDLE="bin/Finirig.app"
          elif [ -d "Release/Finirig.app" ]; then
            APP_BUNDLE="Release/Finirig.app"
          elif [ -d "Finirig.app" ]; then
            APP_BUNDLE="Finirig.app"
          else
            echo "Error: Finirig.app not found in expected locations"
            find . -name "Finirig.app" -type d
            exit 1
          fi

          echo "Found app bundle at: $APP_BUNDLE"

          # Create DMG
          mkdir -p dmg
          cp -R "$APP_BUNDLE" dmg/

          # Create DMG using hdiutil
          hdiutil create -volname "Finirig $VERSION" \
            -srcfolder dmg \
            -ov -format UDZO \
            "Finirig-${VERSION}-macOS.dmg"

      - name: Upload macOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-macos-${{ needs.version.outputs.version }}
          path: |
            build/**/Finirig.app
            build/Finirig-*.dmg
          retention-days: 30

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Qt6
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.6.3 win64_msvc2019_64 -O C:\Qt
          echo "Qt6_DIR=C:\Qt\6.6.3\msvc2019_64" >> $env:GITHUB_ENV

      - name: Setup JUCE
        run: |
          if (-not (Test-Path "third_party\JUCE")) {
            git clone https://github.com/juce-framework/JUCE.git third_party\JUCE
          }

      - name: Generate Icons
        shell: bash
        continue-on-error: true
        run: |
          # Try to generate .ico if ImageMagick is available
          # Check if icon.png exists first
          if [ ! -f "resources/icon.png" ]; then
            echo "resources/icon.png not found, skipping icon generation"
            exit 0
          fi

          # Check for ImageMagick specifically (not Windows convert.exe)
          # Try magick command first (ImageMagick 7+)
          if command -v magick &> /dev/null 2>&1; then
            echo "Using ImageMagick magick command"
            magick resources/icon.png -define icon:auto-resize=256,128,64,48,32,16 resources/Finirig.ico
            exit 0
          fi

          # Try to find ImageMagick convert by checking version output
          # Use full path check to avoid Windows convert.exe
          CONVERT_CMD=""
          for path in /usr/bin/convert /mingw64/bin/convert "$(which convert 2>/dev/null)"; do
            if [ -n "$path" ] && [ -x "$path" ] 2>/dev/null; then
              if "$path" -version 2>&1 | grep -qi "imagemagick"; then
                CONVERT_CMD="$path"
                break
              fi
            fi
          done

          if [ -n "$CONVERT_CMD" ]; then
            echo "Using ImageMagick convert command: $CONVERT_CMD"
            "$CONVERT_CMD" resources/icon.png -define icon:auto-resize=256,128,64,48,32,16 resources/Finirig.ico
          else
            echo "ImageMagick not found, skipping .ico generation (icon is optional)"
          fi

      - name: Configure CMake
        run: |
          # aqtinstall sets Qt6_DIR via GITHUB_ENV
          $QtPath = "$env:Qt6_DIR"
          if (-not $QtPath -or -not (Test-Path $QtPath)) {
            $PossiblePaths = @(
              "$env:ProgramFiles\Qt\6.6.3\msvc2019_64",
              "C:\Qt\6.6.3\msvc2019_64"
            )
            foreach ($path in $PossiblePaths) {
              if (Test-Path $path) {
                $QtPath = $path
                Write-Host "Found Qt6 at: $QtPath"
                break
              }
            }
          }
          if ($QtPath) {
            Write-Host "Configuring with Qt6 at: $QtPath"
            cmake -B build `
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
              -DCMAKE_PREFIX_PATH="$QtPath" `
              -DBUILD_TESTS=OFF `
              -DBUILD_STANDALONE=ON `
              -G "Visual Studio 17 2022" `
              -A x64
          } else {
            Write-Host "Qt6_DIR not set, trying CMake auto-detection"
            cmake -B build `
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
              -DBUILD_TESTS=OFF `
              -DBUILD_STANDALONE=ON `
              -G "Visual Studio 17 2022" `
              -A x64
          }

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create Windows Package
        run: |
          cd build
          $VERSION = "${{ needs.version.outputs.version }}"

          # Find the executable (could be in bin/Release or bin/ depending on generator)
          $exePath = ""
          if (Test-Path "bin\Release\finirig_standalone.exe") {
            $exePath = "bin\Release\finirig_standalone.exe"
          } elseif (Test-Path "bin\finirig_standalone.exe") {
            $exePath = "bin\finirig_standalone.exe"
          } else {
            Write-Error "finirig_standalone.exe not found in expected locations"
            Get-ChildItem -Recurse -Filter "finirig_standalone.exe" | Select-Object FullName
            exit 1
          }

          Write-Host "Found executable at: $exePath"

          # Create zip with executable
          $zipName = "Finirig-${VERSION}-Windows-x64.zip"
          Compress-Archive -Path $exePath -DestinationPath $zipName -Force

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-windows-${{ needs.version.outputs.version }}
          path: |
            build/bin/Release/finirig_standalone.exe
            build/bin/finirig_standalone.exe
            build/Finirig-*.zip
          retention-days: 30

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: version
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            qt6-base-dev \
            libasound2-dev \
            libjack-jackd2-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libcurl4-openssl-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxrender-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            libgtk-3-dev

      - name: Verify FreeType Installation
        run: |
          echo "Checking for FreeType headers..."
          find /usr/include -name "ft2build.h" 2>/dev/null || echo "Warning: ft2build.h not found in /usr/include"
          pkg-config --modversion freetype2 || echo "Warning: freetype2 pkg-config not found"
          dpkg -L libfreetype6-dev | grep -E "(ft2build|freetype)" | head -5

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=OFF \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Create Linux Package
        run: |
          cd build
          VERSION="${{ needs.version.outputs.version }}"

          # Create tarball
          mkdir -p package/finirig-${VERSION}
          cp bin/finirig_standalone package/finirig-${VERSION}/
          cp ../resources/Finirig.png package/finirig-${VERSION}/
          cp ../resources/finirig.desktop package/finirig-${VERSION}/

          # Create install script
          cat > package/finirig-${VERSION}/install.sh << 'EOF'
          #!/bin/bash
          sudo cp finirig_standalone /usr/local/bin/
          sudo cp Finirig.png /usr/share/pixmaps/finirig.png
          sudo cp finirig.desktop /usr/share/applications/
          sudo update-desktop-database
          EOF
          chmod +x package/finirig-${VERSION}/install.sh

          tar -czf Finirig-${VERSION}-Linux-x64.tar.gz -C package finirig-${VERSION}

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: finirig-linux-${{ needs.version.outputs.version }}
          path: |
            build/bin/finirig_standalone
            build/Finirig-*.tar.gz
          retention-days: 30

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [version, build-macos, build-windows, build-linux]
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: Finirig ${{ needs.version.outputs.version }}
          body: |
            ## Finirig ${{ needs.version.outputs.version }}

            ### Downloads

            - **macOS**: [Finirig.dmg](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-macOS.dmg)
            - **Windows**: [Finirig.zip](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-Windows-x64.zip)
            - **Linux**: [Finirig.tar.gz](https://github.com/${{ github.repository }}/releases/download/v${{ needs.version.outputs.version }}/Finirig-${{ needs.version.outputs.version }}-Linux-x64.tar.gz)

            ### Installation

            **macOS**: Open the DMG and drag Finirig.app to Applications.

            **Windows**: Extract the ZIP and run `finirig_standalone.exe`.

            **Linux**: Extract the tarball and run `./install.sh` or manually copy files.

            ### Changes

            See [CHANGELOG.md](CHANGELOG.md) for details.
          files: |
            artifacts/**/*
          draft: ${{ contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'rc') }}
          prerelease: ${{ contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') || contains(needs.version.outputs.version, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  BUILD_TYPE: Debug

jobs:
  build-macos:
    name: Build macOS
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Qt6
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH=$(brew --prefix qt@6) \
            -DBUILD_TESTS=ON \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Test
        run: |
          cd build && ctest --output-on-failure

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            qt6-base-dev \
            libasound2-dev \
            libjack-jackd2-dev \
            libfreetype6-dev \
            libfontconfig1-dev \
            libcurl4-openssl-dev \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxrandr-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxrender-dev \
            libgl1-mesa-dev \
            libvulkan-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev

      - name: Verify FreeType Installation
        run: |
          echo "Checking for FreeType headers..."
          find /usr/include -name "ft2build.h" 2>/dev/null || echo "Warning: ft2build.h not found in /usr/include"
          pkg-config --modversion freetype2 || echo "Warning: freetype2 pkg-config not found"
          dpkg -L libfreetype6-dev | grep -E "(ft2build|freetype)" | head -5

      - name: Setup JUCE
        run: |
          if [ ! -d "third_party/JUCE" ]; then
            git clone https://github.com/juce-framework/JUCE.git third_party/JUCE
          fi

      - name: Configure CMake
        run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DBUILD_TESTS=ON \
            -DBUILD_STANDALONE=ON

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Test
        run: |
          cd build && ctest --output-on-failure

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Qt6
        run: |
          pip install aqtinstall
          aqt install-qt windows desktop 6.6.3 win64_msvc2019_64 -O C:\Qt
          echo "Qt6_DIR=C:\Qt\6.6.3\msvc2019_64" >> $env:GITHUB_ENV

      - name: Setup JUCE
        run: |
          if (-not (Test-Path "third_party\JUCE")) {
            git clone https://github.com/juce-framework/JUCE.git third_party\JUCE
          }

      - name: Configure CMake
        run: |
          # aqtinstall sets Qt6_DIR via GITHUB_ENV
          $QtPath = "$env:Qt6_DIR"
          if (-not $QtPath -or -not (Test-Path $QtPath)) {
            $PossiblePaths = @(
              "$env:ProgramFiles\Qt\6.6.3\msvc2019_64",
              "C:\Qt\6.6.3\msvc2019_64"
            )
            foreach ($path in $PossiblePaths) {
              if (Test-Path $path) {
                $QtPath = $path
                break
              }
            }
          }
          if ($QtPath) {
            cmake -B build `
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
              -DCMAKE_PREFIX_PATH="$QtPath" `
              -DBUILD_TESTS=ON `
              -DBUILD_STANDALONE=ON `
              -G "Visual Studio 17 2022" `
              -A x64
          } else {
            cmake -B build `
              -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
              -DBUILD_TESTS=ON `
              -DBUILD_STANDALONE=ON `
              -G "Visual Studio 17 2022" `
              -A x64
          }

      - name: Build
        run: |
          cmake --build build --config ${{ env.BUILD_TYPE }} --parallel

      - name: Test
        run: |
          cd build && ctest --output-on-failure -C ${{ env.BUILD_TYPE }}
